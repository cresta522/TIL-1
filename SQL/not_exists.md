## NOT EXISTS句について

達人DBの「入れ子集合モデルを使った検索」の単元でNOT EXISTS句が出てきた。

一つのテーブルに二つの別名をつけて自己結合していたけど、ちょっと処理の内容の理解に苦しんだのでメモに残しておく。

社員 | 左端 | 右端
--- | --- | ---
アダム | 1 | 14
イブ | 2 | 3
セト | 4 | 13
カイン | 5 | 8
ヨブ | 6 | 7
アベル | 9 | 10
ノア | 11 | 12

こんな感じのテーブルがあってリーフ、つまり自分の中に他の円を一つも含まない円を求めるためのSQL文は

``` SQL
SELECT *
  FROM 組織図 上司
 WHERE NOT EXISTS
       (SELECT *
          FROM 組織図 部下
         WHERE 部下.左端 > 上司.左端
           AND 部下.左端 < 上司.右端);
```

NOT EXISTS句ではサブクエリの検索結果が0件の場合のみ`TRUE`を返す。

WHERE句の内容が`TRUE`になるということはその時のサブクエリの内容はメインクエリでの抽出対象となる。

先ほどのSQL文を分解してみると、まずメインクエリで取り出したレコードが一番初めの「アダム」であった場合、WHEREの内容は下記のようになる

``` SQL
WHERE 部下.左端 > 1
  AND 部下.左端 < 14
```

となる。サブクエリの結果はアダム以外全てが当てはまるため`FALSE`である。つまり、メインクエリのWHERE句での抽出対象ではない。

続いて、メインクエリで取り出すレコードが「イブ」であるとき。

``` SQL
WHERE 部下.左端 > 2
  AND 部下.左端 < 3
```

この場合、検索結果は0件。つまり、`TRUE`が返され、メインクエリでの抽出対象（リーフ)となる。

これを繰り返し行い、メインクエリで全てのレコードを抽出して確かめる。

そうすると、イブ、ヨブ、アベル、ノアが残る。これらがリーフということになる。



--- 

参考: 「達人に学ぶDB設計徹底指南書」　ミック著











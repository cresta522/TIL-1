## トランザクション

### トランザクションとは

AさんからBさんへ1000円送金するという場合、Aさんの残高を-1000、Bさんの残高を+1000というUPDATE文が二つ発生することになる。

このUPDATE文がなんらかの原因で中断されてしまったとする。Aさんの残高が-1000されたけど、Bさんの残高が増えていない場合、大変。

このようなトラブルは絶対に起きてはいけないので、上の二つのSQLは一つのかたまりとしておく必要がある。そうすると、二つのUPDATEが無事成功すれば、処理完了、もし何らかの原因で処理が中断された場合、
SQL文の片方は完了…ではなく、どちらのSQL文も実行していない状態（まっさらな状態）となっている必要がある。

このように、1つ以上のSQL文をひとかたまりとして扱うように指示ができる。このかたまりのことを**トランザクション**という。

### トランザクションの制御

DBMSはトランザクションを

- 途中で処理が中断されないようにする
- 途中で他の人の処理が割り込めないようにする

のように扱っている。（トランザクションの制御)

トランザクションの処理において、トランザクション内の単品のSQLが実行されると、それぞれ「仮に書き換えた」状態になる。全てのSQL文が問題なく実行できたときに初めて「仮に書き換えた状態」から「処理が確定した」状態になる。
このことを**コミット**という。

途中でなんらかの問題が起き、まっさらな状態に戻すこことを**ロールバック**という。

---

### トランザクションを使うための指示

指示 | 意味
--- | ---
BEGIN | 開始の指示。この指示以降のSQL文を一つのトランザクションとする
COMMIT | 終了の指示。この指示までを一つのトランザクションとし、変更を確定する
ROLLBACK | 終了の指示。この指示までを一つのトランザクションとし、変更の取り消しをする。

例

``` SQL
BEGIN; -- これより下がトランザクション
-- アーカイブテーブルへコピーする処理
INSERT INTO アーカイブ
SELECT FROM 現行データ WHERE句;
-- 現行データから、アーカイブに移したデータを削除
DELETE FROM 現行データ WHERE句;
COMMIT; -- ここより上がトランザクション
```
　
 こうすると、`BEGIN;`より下、`COMMIT;`より上がトランザクションとなり、不可分なものとして扱われる。この、トランザクションが不可分のものとして扱われることを**トランザクションの原子性**という。
 
 
 
 
